Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: init

%post
    mkdir /build

    cat <<'EOF' > /build/init.sh
        export BUILD_DIR="/build"
        export ENV_FILE="${BUILD_DIR}/env.sh"

        # Adds an environment variable to singularity env.
        add_env () {
          for arg in $@; do
            eval echo "export ${arg}=\"\${${arg}}\"" >> ${SINGULARITY_ENVIRONMENT}
            eval echo "export ${arg}=\"\${${arg}}\"" >> ${ENV_FILE}
          done
        }

        # Adds a path to the environment, without overwriting it.
        prepend_path () {
          eval echo "export ${1}=\"${2}:\\\${${1}}\"" >> ${SINGULARITY_ENVIRONMENT}
          eval echo "export ${1}=\"${2}:\\\${${1}}\"" >> ${ENV_FILE}
          eval export ${1}="${2}:\${${1}}"
        }

        NCPU="$(grep -c ^processor /proc/cpuinfo)"

        # Set these with empty defaults to avoid using unset variables in path adds
        export PATH="${PATH-}"
        export INCLUDE="${INCLUDE-}"
        export CPATH="${CPATH-}"
        export LIBRARY_PATH="${LIBRARY_PATH-}"
        export LD_LIBRARY_PATH="${LD_LIBRARY_PATH-}"
        export LD_RUN_PATH="${LD_RUN_PATH-}"

        # We will build everything in here
        mkdir -p "${BUILD_DIR}"
EOF


Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: spaln_builder

%files from init
    /build/init.sh

%post
    set -eux

    . /build/init.sh

    export SPALN_VERSION="Ver.2.3.3"
    export SPALN_PREFIX="/opt/spaln/${SPALN_VERSION}"
    export SPALN_REPO="https://github.com/ogotoh/spaln.git"
    export ALN_TAB="${SPALN_PREFIX}/table"
    export ALN_DBS="${SPALN_PREFIX}/seqdb"

    add_env SPALN_VERSION SPALN_PREFIX ALN_DBS ALN_TAB
    prepend_path PATH "${SPALN_PREFIX}/bin:${SPALN_PREFIX}/perl"

    apt-get update
    apt-get install -y \
      build-essential \
      git \
      zlib1g-dev

    # Runtime requires
    #   perl
    #   zlib1g

    rm -rf /var/lib/apt/lists/*

    cd /build
    git clone "${SPALN_REPO}" spaln
    cd spaln

    git fetch --tags
    git checkout "tags/${SPALN_VERSION}"
    cd src

    ./configure \
      --use_zlib=1 \
      --exec_prefix="${SPALN_PREFIX}/bin" \
      --table_dir="${SPALN_PREFIX}/table" \
      --alndbs_dir="${SPALN_PREFIX}/seqdb"

    make
    make install
    mv ../perl "${SPALN_PREFIX}/perl"


Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: codingquarry_builder

%files from init
    /build/init.sh

%post
    set -eux

    . /build/init.sh
    export CODINGQUARRY_VERSION="v2.0"
    export CODINGQUARRY_PREFIX="/opt/codingquarry/${CODINGQUARRY_VERSION}"
    export CODINGQUARRY_URL="https://downloads.sourceforge.net/project/codingquarry/CodingQuarry_v2.0.tar.gz"
    export QUARRY_PATH="${CODINGQUARRY_PREFIX}/QuarryFiles"

    add_env CODINGQUARRY_PREFIX CODINGQUARRY_VERSION QUARRY_PATH
    prepend_path PATH "${CODINGQUARRY_PREFIX}/bin"

    apt-get update
    apt-get install -y \
      build-essential \
      wget

    # Runtime requires
    #  libgomp1

    rm -rf /var/lib/apt/lists/*

    cd /build
    wget -O codingquarry.tar.gz "${CODINGQUARRY_URL}"
    tar -zxf codingquarry.tar.gz
    cd CodingQuarry*

    make -f makefile
    mkdir -p "${CODINGQUARRY_PREFIX}/bin"
    cp -r CodingQuarry "${CODINGQUARRY_PREFIX}/bin"
    cp -r run_CQ-PM_stranded.sh "${CODINGQUARRY_PREFIX}/bin"
    cp -r run_CQ-PM_unstranded.sh "${CODINGQUARRY_PREFIX}/bin"
    cp -r run_CQ-PM_mine.sh "${CODINGQUARRY_PREFIX}/bin"
    cp -r QuarryFiles "${QUARRY_PATH}"


Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: final

%labels
    Author "darcy.ab.jones@gmail.com"
    Version "v0.0.1"

%help
    This is some help text

%test
    echo "Can add tests here"

%files from spaln_builder
    /opt/spaln
    /build/env.sh /build/spaln_builder.sh

%files from codingquarry_builder
    /opt/codingquarry
    /build/env.sh /build/codingquarry_builder.sh

%post
    set -eu

    cat /build/*.sh >> ${SINGULARITY_ENVIRONMENT}
    export DEBIAN_FRONTEND=noninteractive

    # This prevents java install from panicking
    mkdir -p /usr/share/man/man1

    apt-get update
    apt-get install -y --no-install-recommends \
      libgomp1 \
      locales \
      perl \
      python \
      python-biopython \
      zlib1g

    rm -rf /var/lib/apt/lists/*

    # Set locales for perl
    sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
    dpkg-reconfigure --frontend=noninteractive locales
    update-locale LANG=en_US.UTF-8

    echo 'export LANG="en_US.UTF-8"' >> ${SINGULARITY_ENVIRONMENT}
    export LANG="en_US.UTF-8"
