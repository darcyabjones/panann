Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: init

%post
    mkdir /build

    cat <<'EOF' > /build/init.sh
        export BUILD_DIR="/build"
        export ENV_FILE="${BUILD_DIR}/env.sh"

        # Adds an environment variable to singularity env.
        add_env () {
          for arg in $@; do
            eval echo "export ${arg}=\"\${${arg}}\"" >> ${SINGULARITY_ENVIRONMENT}
            eval echo "export ${arg}=\"\${${arg}}\"" >> ${ENV_FILE}
          done
        }

        # Adds a path to the environment, without overwriting it.
        prepend_path () {
          eval echo "export ${1}=\"${2}:\\\${${1}}\"" >> ${SINGULARITY_ENVIRONMENT}
          eval echo "export ${1}=\"${2}:\\\${${1}}\"" >> ${ENV_FILE}
          eval export ${1}="${2}:\${${1}}"
        }

        NCPU="$(grep -c ^processor /proc/cpuinfo)"

        # Set these with empty defaults to avoid using unset variables in path adds
        export PATH="${PATH-}"
        export INCLUDE="${INCLUDE-}"
        export CPATH="${CPATH-}"
        export LIBRARY_PATH="${LIBRARY_PATH-}"
        export LD_LIBRARY_PATH="${LD_LIBRARY_PATH-}"
        export LD_RUN_PATH="${LD_RUN_PATH-}"

        # We will build everything in here
        mkdir -p "${BUILD_DIR}"
EOF



Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: gmap_builder

%files from init
    /build/init.sh

%post
    set -eux

    . /build/init.sh

    export GMAP_VERSION="2019-05-12"
    export GMAP_PREFIX="/opt/gmap/${GMAP_VERSION}"
    export GMAP_URL="http://research-pub.gene.com/gmap/src/gmap-gsnap-2019-05-12.tar.gz"

    add_env GMAP_PREFIX GMAP_VERSION
    prepend_path PATH "${GMAP_PREFIX}/bin"

    apt-get update
    apt-get install -y \
      build-essential \
      libbz2-dev \
      perl \
      wget \
      zlib1g-dev

    # Runtime requires
    # libbz2-1.0
    # perl
    # zlib1g

    rm -rf /var/lib/apt/lists/*

    cd /build
    wget -O gmap.tar.gz "${GMAP_URL}"
    tar -zxf gmap.tar.gz
    rm gmap.tar.gz

    cd gmap*

    ./configure --prefix="${GMAP_PREFIX}"
    make
    make check
    make install


Bootstrap: docker
From: debian:stretch-20190228-slim
Stage: final

%labels
    Author "darcy.ab.jones@gmail.com"
    Version "v0.0.1"

%help
    This is some help text

%test
    echo "Can add tests here"

%files from gmap_builder
    /opt/gmap
    /build/env.sh /build/gmap_builder.sh

%post
    set -eu

    cat /build/*.sh >> ${SINGULARITY_ENVIRONMENT}

    # This prevents java install from panicking
    mkdir -p /usr/share/man/man1
    apt-get update
    apt-get install -y --no-install-recommends \
      libbz2-1.0 \
      perl \
      zlib1g

    rm -rf /var/lib/apt/lists/*
